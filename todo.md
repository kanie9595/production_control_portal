# Production Control Portal - Multi-Role Checklists

## Phase 1: Upgrade to full-stack
- [x] Run webdev_add_feature web-db-user
- [x] Review generated README and migration guidance

## Phase 2: Database schema & API
- [x] Create DB tables: roles, checklist_templates, template_items, checklist_instances, instance_items
- [x] Create API routes: CRUD for templates, instances, items
- [x] Seed default roles and checklist templates from existing data
- [x] Add real-time polling endpoint for manager dashboard

## Phase 3: Frontend
- [x] Role selection / login flow (manager vs employee)
- [x] Employee view: see assigned checklist, check items, add notes
- [x] Manager dashboard: view all employees' checklists in real-time
- [x] Manager: edit checklist template items (add/remove/rename)
- [x] Manager: assign checklist templates to roles
- [x] Responsive mobile layout for shop floor use

## Phase 4: Testing & delivery
- [x] Test all flows end-to-end
- [x] Fix bugs (no bugs found)
- [x] Save checkpoint and deliver

## Update 2: New roles, access control, checklists, registration
- [x] Add role: Директор производства (can view all checklists like Начальник производства)
- [x] Add role: Помощница начальника смены (with unique checklist)
- [x] Add role: Бригадир упаковщиков (with unique checklist)
- [x] Add role: Старший механик (with unique checklist)
- [x] Add role: Старший наладчик ТПА (with unique checklist)
- [x] Restrict monitoring dashboard: only Директор производства and Начальник производства can view
- [x] Hide monitoring/templates/users cards from non-manager roles on Home page
- [x] Create checklist for Помощница начальника смены
- [x] Create checklist for Бригадир упаковщиков
- [x] Create checklist for Старший механик
- [x] Create checklist for Старший наладчик ТПА
- [x] Add registration instructions page
- [x] Update seed data with new roles and checklists
- [x] Update tests for new access control logic
- [x] Save checkpoint and deliver

## Update 3: Аналитика, Задачи, Отчёты, Заказы, Сырьё

### Аналитика чек-листов
- [x] История выполнения чек-листов (по дням/неделям/месяцам)
- [x] Графики выполнения (по должностям, по сотрудникам)
- [x] Сохранение истории чек-листов
- [x] Экспорт чек-листов в PDF

### Задачи
- [x] Таблица задач в БД (assignee, creator, status, deadline, description)
- [x] API для CRUD задач
- [x] Назначение задач конкретному сотруднику
- [x] Начальник и Директор видят все задачи в реальном времени
- [x] Остальные видят только свои задачи
- [x] Уведомление сотруднику о новой задаче
- [x] Уведомление начальнику производства о новой задаче
- [x] Фронтенд страница задач

### Отчёты (сменные)
- [x] Таблица отчётов в БД с полями: станок, пресс-форма, цвет, план, факт, цикл стандарт/факт, простой, причина, брак, переналадка
- [x] Редактируемые списки выбора (станки, пресс-формы, цвета, причины простоя)
- [x] API для CRUD отчётов
- [x] Аналитика по параметрам (цикл, простой, брак, переналадка) для одного продукта
- [x] Сохранение истории отчётов
- [x] Экспорт отчётов в PDF
- [x] Фронтенд страница отчётов с формой и аналитикой

### Заказы
- [x] 27 станков в системе
- [x] Таблица заказов в БД (станок, продукция, количество, статус, история)
- [x] API для CRUD заказов
- [x] Карточки станков с информацией о текущем заказе
- [x] Полная информация о заказе при клике на станок
- [x] Начальник и Директор могут создавать заказы
- [x] История заказов на каждом станке
- [x] Уведомления начальнику смены, главному наладчику и наладчикам о новом заказе
- [x] Фронтенд страница заказов

### Сырьё
- [x] Таблица рецептов сырья в БД
- [x] API для CRUD рецептов
- [x] Привязка рецепта к заказу
- [x] Фронтенд страница сырья

### Общее
- [x] Обновить навигацию (Home) с новыми разделами
- [x] Обновить App.tsx с новыми маршрутами
- [x] Написать тесты для новых модулей
- [x] Сохранить чекпоинт и доставить

## Update 4: Справочники и Управление правами ролей

### Справочники (Lookup Lists)
- [x] Страница «Справочники» для управления списками выбора в отчётах
- [x] Управление списком станков (добавить ТПА-01 — ТПА-27)
- [x] Управление списком пресс-форм с продукцией
- [x] Управление списком цветов изделий
- [x] Управление списком причин простоя
- [x] Кнопка быстрого заполнения станков (1-27)

### Управление правами ролей
- [x] Таблица role_permissions в БД (роль + модуль + доступ)
- [x] API для CRUD прав ролей
- [x] Страница «Управление правами» для Начальника и Директора производства
- [x] Возможность включать/выключать доступ к модулям для каждой роли
- [x] Применение прав на фронтенде (скрытие недоступных модулей)
- [x] Применение прав на бэкенде (проверка доступа в API)

### Общее
- [x] Обновить навигацию (Home) с новыми разделами
- [x] Обновить App.tsx с новыми маршрутами
- [x] Написать тесты для новых модулей
- [x] Сохранить чекпоинт и доставить

## Update 5: Связка отчётов и заказов, выпадающие списки, единицы измерения

### Заказы — изменения
- [x] Убрать графу «Сырьё» (rawMaterial) из заказов
- [x] Изменить единицу измерения с «шт.» на «кор.»
- [x] Выпадающий список для продукции (из справочника пресс-форм)
- [x] Выпадающий список для цвета (из справочника цветов)
- [x] Выпадающий список для пресс-формы (из справочника пресс-форм)
- [x] Показывать в заказе: общий план, выполнено факт, осталось

### Связка отчётов и заказов
- [x] При заполнении «факт» в отчёте — автоматически обновлять completedQty в заказе
- [x] Привязка строки отчёта к конкретному заказу (orderId)
- [x] Показывать остаток по заказу в реальном времени

### Общее
- [x] Обновить API для заказов и отчётов
- [x] Обновить фронтенд заказов и отчётов
- [x] Написать тесты (73/73 passed)
- [x] Сохранить чекпоинт и доставить

## Update 6: Автозаполнение, привязка продукции, роли, удаление отчётов, уведомления, статусы станков

### Отчёты — улучшения
- [x] Автозаполнение графы «План» из привязанного заказа
- [x] Удаление отчётов (доступно Начальнику производства)

### Привязка продукции к пресс-формам
- [x] Связь продукция → пресс-форма (одна продукция может иметь несколько пресс-форм)
- [x] При выборе продукции — показывать только связанные пресс-формы
- [x] Обновить справочники для управления связями

### Управление ролями
- [x] Добавление новых ролей
- [x] Редактирование существующих ролей (название, описание)

### Заказы и станки
- [x] При смене статуса заказа на «В работе» — менять статус станка на «Работает»
- [x] При завершении заказа — менять статус станка на «Простой»
- [x] Уведомление начальнику производства при завершении заказа

### Общее
- [x] Обновить API
- [x] Обновить фронтенд
- [x] Написать тесты (89/89 passed)
- [x] Сохранить чекпоинт и доставить

## Bugfix: Ошибка вставки строки отчёта
- [x] Исправить передачу пустых строк вместо null для числовых полей (standardCycle, actualCycle и др.)

## Update 7: Рецепты сырья, настраиваемые графы, средний вес, аналитика

### Рецепты сырья — привязка к продукции
- [x] Таблица product_recipes (продукция → список компонентов с процентами)
- [x] Справочник рецептов: добавление/редактирование формул (компонент + %)
- [x] При создании заказа — автоматическая заявка на сырьё по рецепту
- [x] Расчёт кг по формуле: ввод кг основного компонента → авторасчёт остальных по %
- [x] Поле «Партия сырья» (необязательное, заполняется вручную)
- [x] Показывать дату заказа на сырьё

### Настраиваемые графы отчёта
- [x] Таблица custom_report_fields (название, тип, обязательность, порядок)
- [x] CRUD для настраиваемых граф в справочнике
- [x] Отображение настраиваемых граф в форме отчёта
- [x] Хранение значений настраиваемых граф

### Средний вес в отчёте
- [x] Графа «Средний вес» и «Стандарт веса» в отчёте начальника смены
- [x] Стандарт веса задаётся в справочнике (привязка к продукции)

### Аналитика
- [x] Аналитика по продукции (что и сколько заказывают на станках)
- [x] Аналитика по сырью (расход по компонентам)

### Общее
- [x] Обновить API
- [x] Обновить фронтенд
- [x] Написать тесты (113/113 passed)
- [x] Сохранить чекпоинт и доставить

## Bugfix: standardWeight не принимает диапазоны
- [x] Изменить тип поля standardWeight с decimal на varchar для поддержки диапазонов (16,2-16,9)
