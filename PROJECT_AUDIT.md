# Быстрый аудит проекта production_control_portal

## Что уже хорошо
- Современный стек: React 19 + Vite + tRPC + Drizzle + Vitest.
- Есть проверка окружения через `zod`.
- Есть базовые тесты для доменных сценариев (orders/reports/checklist/permissions).

## Приоритетные улучшения

### 1) Стабилизировать TypeScript-слой (P0)
Сейчас `pnpm check` падает: есть ошибки в AI-компонентах и в обработке ошибок `zod`.

Что сделать:
- Починить типы в `client/src/components/AIChatBox.tsx` и `client/src/components/Markdown.tsx`.
- Обновить обработку `ZodError` в `server/_core/env.ts` (использовать актуальные поля ошибки).
- Добавить CI-гейт, чтобы `pnpm check` был обязательным.

### 2) Разбить монолитный tRPC router (P0)
`server/routers.ts` содержит слишком много доменных областей в одном файле.

Что сделать:
- Вынести роутеры по доменам: `auth.router.ts`, `orders.router.ts`, `reports.router.ts`, `tasks.router.ts` и т.д.
- Собирать корневой router из модулей.
- Упростить сопровождение, ревью и тестирование.

### 3) Убрать N+1 и дорогие циклы в аналитике (P1)
В `dashboard.overview` и `getChecklistHistory` видны повторные вызовы/поиски в циклах.

Что сделать:
- Выгружать агрегаты SQL-запросом (join/group) вместо многократных выборок.
- Вынести обогащение данных в сервис с кэшированием справочников в Map.
- Добавить бенчмарк на объемах (например, 10k instance items).

### 4) Централизовать бизнес-логику ролей/прав (P1)
Проверки ролей частично дублируются (admin/manager/user ветки в разных ручках).

Что сделать:
- Вынести policy-слой (например, `canManageOrders(user)`, `canDeleteReport(user)`).
- Единообразно использовать policy в router и UI.
- Добавить unit-тесты на матрицу ролей.

### 5) Повысить надежность интеграционных тестов (P1)
Текущие тесты сильно завязаны на состояние БД и иногда делают ранний `return` вместо явного `skip`.

Что сделать:
- Использовать отдельную тестовую БД/транзакции на тест.
- Явно сидировать сущности для сценария.
- Убрать неявные skip-пути, чтобы тесты были детерминированными.

### 6) Добавить базовую observability (P2)
Сейчас логирование местами есть, но нет единого trace/request-id уровня.

Что сделать:
- Ввести структурированные логи на сервере (request id, user id, router, duration).
- Добавить метрики p95/p99 по критичным ручкам (`dashboard`, `reports`, `orders`).
- Настроить алерты на рост ошибок 5xx и деградацию latency.

### 7) Улучшить DX/документацию (P2)
В репозитории нет базового README для быстрого входа.

Что сделать:
- Добавить README: запуск, ENV, команды, архитектура модулей.
- Добавить ADR по ролям/правам и по структуре роутеров.

## Предложенный план на 2 спринта

### Спринт 1
1. Починить `pnpm check` и включить в CI.
2. Разделить `server/routers.ts` на доменные модули.
3. Почистить N+1 в `dashboard.overview` и `getChecklistHistory`.

### Спринт 2
1. Вынести policy-слой прав доступа.
2. Сделать детерминированные интеграционные тесты с сидированием.
3. Добавить README + базовую observability.
